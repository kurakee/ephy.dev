---
title: QwikCity + CloudflarePages + Newtでブログを作る
description: Newt公式のチュートリアルを参考にブログを作成する過程でハマったところやチュートリアル外での作業などを紹介します。
opengraph:
  - title: QwikCity + CloudflarePages + Newtでブログを作る
    description: true
  - image: https://storage.ephy.dev/blog-resources/article-cloudflare-pages/cover/image.webp
    image:alt: 記事のカバー画像
publishedAt: "2023-12-06"
tags:
  - Frontend
  - Qwik
  - Cloudflare
---

import { FigImage } from "~/components/utils/fig-image.tsx";

## 概要

この記事では途中ハマったポイントや、追加で行った雑多な事などをメモします。

基本的には[公式チュートリアル](https://www.newt.so/docs/tutorials/get-contents-in-qwik-city)に従って作成し、CloudflarePages にデプロイする前後のところまで完了している状態を前提にしています。

## 記事を読む前に

コードブロックなどは所々省略されていたりするので、コピペでは動かないかもしれません。もし参考にされる方が居たら、記事執筆時点のブランチを参考にしてください。

[Github - ephy.dev](https://github.com/kurakee/ephy.dev/tree/save/2023-12-08)

## CloudflarePages へデプロイするところ

内容をなぞるだけで一旦はデプロイ前までいけますが、Newtのライブラリがfetch()に対応していないなどの理由からaxios-fetch-adapterを導入する辺りでビルド時にコケるかもしれないです。自分が遭遇したのは以下のエラーです。

```
Module not found: Package path ./lib/core/settle is not exported from ~
```

axiosはセキュリティ関係のアップデートが近年あったように記憶していますが、[axios-fetch-adapter](https://github.com/vespaiach/axios-fetch-adapter)は特にメンテナンスされてないようです。

axios-fetch-adapterのindex.jsでaxios関係のimportがうまく行えていないのが原因で、最新のaxiosだと/libからではなく/unsafeからでないと呼べなかったりする様子です。

また、forkして少し書き換えて見ましたが、isStandardBrowserEnv()等の実装はすでに/utilsにはなく、どのみち動きませんでした。

> index.js

```javascript
import settle from "axios/lib/core/settle"; // axios/unsafe/core/settleというように呼ぶ
import buildURL from "axios/lib/helpers/buildURL";
import buildFullPath from "axios/lib/core/buildFullPath";
import { isUndefined, isStandardBrowserEnv, isFormData } from "axios/lib/utils";
```

[issue](https://github.com/vespaiach/axios-fetch-adapter/issues/22)も上がっていて、困っている人は去年から居るっぽいですね。

とりあえず、たまたま見つけたフォークリポジトリのものを拝借することにして、無事ビルドとデプロイが通りました。

[konfig-axios-fetch-adapter](https://github.com/konfig-dev/konfig-axios-fetch-adapter/)

信用できるかは不明なので各自別のものを探したり、axios-fetch-adapterをforkして自分で動くように細かな対応をするなど必要です。

---

ここからは自分が行った追加の作業や簡単なTipsになります。

## CloudflarePages

独自ドメイン設定、アクセス制御、リダイレクト設定を行います。

- 独自ドメイン設定
  - [https://kshida-blog.com/posts/set-my-domain-to-cloudflare-pages](https://kshida-blog.com/posts/set-my-domain-to-cloudflare-pages)
  - [https://zenn.dev/kameoncloud/articles/9154d4dd27fe15](https://zenn.dev/kameoncloud/articles/9154d4dd27fe15)
- Access-policy
  - 開発中はアクセス出来ないようにする
  - [https://dev.classmethod.jp/articles/cloudflare-pages-access/](https://dev.classmethod.jp/articles/cloudflare-pages-access/)
- リダイレクト設定 (BulkRedirect)
  - \*.pages.devドメインから独自ドメインにリダイレクトさせる
  - [https://astro.gdgd.tokyo/posts/cf-redirects/](https://astro.gdgd.tokyo/posts/cf-redirects/)

また、CloudflarePages へデプロイする際に以下のエラーが出るときがありました。

```
✘ [ERROR] Received a malformed response from the API
```

時間をおいて再デプロイを何度かすると問題なく通るので焦らずにちょこちょこと再デプロイしてみてください。

## 末尾スラッシュ自動付与の解除(trailingSlash)

末尾スラッシュの自動付与が個人的に好きではないのでオフにしました。

作業内容としては、vite.config.js内のプラグインプロパティにある、qwikCity()にtrailingSlash: falseを渡すようにしています。

> vite.config.js

```js
import { defineConfig } from "vite";
import { qwikVite } from "@builder.io/qwik/optimizer";
import { qwikCity } from "@builder.io/qwik-city/vite";
import tsconfigPaths from "vite-tsconfig-paths";

export default defineConfig(() => {
  return {
    plugins: [qwikCity({ trailingSlash: false }), qwikVite(), tsconfigPaths()],
    // 省略
  };
});
```

その他にも設定できる項目はあるようです。

[Qwik - vite](https://qwik.builder.io/docs/advanced/vite/)

## リンク先のprefetch

Qwikには便利機能のprefetchがあります。QwikのLinkコンポーネントで作成したリンクにprefetchを設定すると、リンクをホバーなどした時点で次のページの読み込みを始めます。

[Qwik - Link Prefech](https://qwik.builder.io/docs/routing/#link-prefetch)

```jsx
import { Link } from "@builder.io/qwik-city";

<Link prefetch href="/blog">
  Blog
</Link>;
```

## Qwikアイコン追加

デザインを整えていく上で、何種類かアイコンが欲しかったので追加します。

```
npm install @qwikest/icons
```

今回はBootstrap系Githubアイコンを追加。

```tsx
import { BsGithub } from "@qwikest/icons/bootstrap";
// 中略
<BsGithub />;
```

Bootstrap系に加え、Octicons(Github系)やHeroicons(Tailwind系)のアイコンも選べるので、公式のドキュメントを見てみてください。

[Qwik - icons#qwikesticons](https://qwik.builder.io/docs/integrations/icons/#qwikesticons)

## Qwik特有の状態管理とかお作法

状態管理は基本的に以下のような感じになっています。

- useSignal() 単一プロパティに対して使用
- useStore() オブジェクトに対して使用

Reactで言うところのuseState()ですね。

特に、useStore()にその状態に対してのメソッドを埋め込むのはQwikらしさがありますね。

```typescript
import { $, useStore } from "@builder.io/qwik";
const state = useStore<CountStore>({
  count: 0,
  increment: $(function (this: CountStore) {
    this.count++;
  }),
}); // onClick$={() => state.increment()} のように使用
```

上記の例に近い話で、onClick$()などにはQRL化できる状態でないとメソッドを渡すことは出来ず怒られます。

```
Captured variable in the closure can not be serialized because it's a function named "hogeMethod".
You might need to convert it to a QRL using $(fn)
```

```typescript
import { $ } from "@builder.io/qwik";
// NG
const hogeMethod = () => console.log("hoge");
// onClick$={() => hogeMethod()}

// OK
const fugaMethod = $(() => console.log("fuga"));
// onClick$={() => fugaMethod()}
```

他にもuseCompoted$()やuseResource$()などありますが、今回は使用しないのでまたいつか深堀りしてみたいです。

[Qwick - State](https://qwik.builder.io/docs/components/state/)

## Qwikの画像の取り扱いについて

最終的にストレージサービスやCDN経由になってしまう気がしなくもないのですが、「そういう機能もある」という程度に触っておきたいと思います。

Newt から得ている情報はそのままですが、サイト用のプロフィール画像とかはどうやって取り扱うのかと思ったらかなりいい感じでした。src/media/images/profile.pngといったようにsrcの配下に画像を配置し、以下のように読み込みます。

```tsx
import ProfileImage from "~/media/images/profile.png?jsx";

<ProfileImage style={{ width: "128px", height: "128px" }} />;
```

webp化とか最適な表示分けなど全部自動でやってimgタグに変換してくれるのでいい感じだと思いました。

その他詳細は公式を参照してください。
[Qwik - Image Optimization](https://qwik.builder.io/docs/integrations/image-optimization/)

## Reactを書いてる人向けのお役立ちドキュメント

Qwik のドキュメントに React との対比ページがあるので、これを見ると React 書いてる人は理解・置き換えしやすいかもしれません。

[Qwik - React Cheat Sheet](https://qwik.builder.io/docs/guides/react-cheat-sheet/)

## TailwindCSSを導入

いろいろな選択肢が最近はありますが、とりあえずTailwindCSSにしてみました。

```
npm run qwik add tailwind
```

> global.css

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

prettierにclassのソート、.cssファイルでのCSS Propertyに対するソート、importに対するソートをしてくれるプラグインを追加します。

```
npm install -D prettier prettier-plugin-tailwindcss prettier-plugin-css-order prettier-plugin-organize-imports
```

> .prettierrc.yml

```yml
plugins:
  - prettier-plugin-tailwindcss
  - prettier-plugin-css-order
  - prettier-plugin-organize-imports
```

vscodeを使用していてprettierが自動整形してくれない!!という時は、cmd+shift+PからFormat Documentを実行して prettierを指定してください。vscodeの"editor.formatOnSave": trueも忘れずに。

[Qwik - Tailwind](https://qwik.builder.io/docs/integrations/tailwind/)

## PostCSS周りの調整

Newtから受け取った記事データに対してCSSを当てたいわけですが、通常のCSSだとNest出来ないのでPostCSSの調整をします。

```
npm install -D postcss
```

```
npm run qwik add postcss
```

PostCSSを追加するだけだとtailwindが警告してくるみたいなので、設定を修正します。

[Qwik - Using with Preprocessors#Nesting](https://tailwindcss.com/docs/using-with-preprocessors#nesting)

```
[vite:css] Nested CSS was detected, but CSS nesting has not been configured correctly.
Please enable a CSS nesting plugin *before* Tailwind in your configuration.
See how here: https://tailwindcss.com/docs/using-with-preprocessors#nesting
```

> postcss.config.js

```javascript
module.exports = {
  plugins: {
    "postcss-import": {},
    "tailwindcss/nesting": "postcss-nesting",
    "postcss-preset-env": {
      stage: 3,
      features: {
        "nesting-rules": true,
      },
    },
    tailwindcss: {},
    autoprefixer: {},
  },
};
```

[Qwik - PostCSS](https://qwik.builder.io/docs/components/styles/#postcss)

## eslintが\*.config.jsに対してお怒りになっている場合

.eslintignoreへ以下を追加

```
tailwind.config.js
prettier.config.js
postcss.config.js
```

## 記事用のCSS調整

/src/stylesディレクトリを作成してからglobal.cssを移動させて、root.tsxの読み込み先を修正します。

> root.tsx

```
import "~/styles/global.css";
```

名前は何でもいいですが、ブロク記事部分のCSSを書くためのcssファイルを/src/stylesに作成します。

> newt-blog-body.css

```css
/* .markdownじゃなくてもOK */
.markdown {
  img,
  video {
    margin: 1em auto;
    max-width: 80%;
    height: auto;
  }
  /* 省略 */
}
```

CSSを作成したら、記事コンポーネントの方で読み込みます。記事を表示する部分に対しては.markdownのクラス配下となるようにしておきます。

```tsx
import { component$, useStyles$ } from "@builder.io/qwik";
import blogBodyStyle from "~/styles/newt-blog-body.css?inline"; //?inlineをつける

export default component$(() => {
  const article = useArticle();
  useStyles$(blogBodyStyle);

  return (
    <>
      <div class="markdown" dangerouslySetInnerHTML={article.value.body} />
    </>
  );
});
```

## CSP 対応

/src/routesにplugin\@csp.tsを作成し、以下のような感じで設定します。ただ、CSP設定に関してはこれが正解というわけではないので、自身で外部から読み込むドメインなどの設定を行う必要があります。

以下の例では、youtube埋め込み系やnewtを許可したりしています。

```typescript
import type { RequestHandler } from "@builder.io/qwik-city";
import { isDev } from "@builder.io/qwik/build";

export const onRequest: RequestHandler = (event) => {
  if (isDev) return;
  const nonce = Date.now().toString(36);
  event.sharedMap.set("@nonce", nonce);
  const csp = [
    ["default-src", "'self'", "'unsafe-inline'"],
    ["connect-src", "'self'", "data:", "blob:"],
    ["script-src", "'self'", "'unsafe-inline'", "https:", `'nonce-${nonce}'`, "strict-dynamic"],
    ["frame-src", "'self'", `'nonce-${nonce}'`, "*.youtube.com", "*.google.com"],
    ["img-src", "'self'", "*.newt.so", "*.ytimg.com"],
    ["media-src", "'self'", "*.newt.so"],
  ];

  event.headers.set("Content-Security-Policy", csp.map((k) => k.join(" ")).join("; "));
};
```

nonceに関しては一回限りのランダムな文字列を生成してinline-scriptなどに埋め込むやつです。root.tsxのServiceWorkerRegisterに渡すようにする必要があります。

> src/root.tsx

```tsx
export default component$(() => {
  const nonce = useServerData<string | undefined>("nonce");
  return (
    <QwikCityProvider>
      {/* 省略 */}
      <ServiceWorkerRegister nonce={nonce} />
      {/* 省略 */}
    </QwikCityProvider>
  );
});
```

[Qwik - Content Security Policy](https://qwik.builder.io/docs/advanced/content-security-policy/)

## manifest.json のエラー

Cloudflare Pagesのアクセス制御をしていたりプレビュー機能を使ったりしていて、以下のようなエラーが出る場合の対応もしておきます。これはmanifest.jsonを取得したときに認証が通らずにエラーページなどが返されてしまって、それがhtml形式だったりする時に出るものです。

```
Manifest: Line: 1, column: 1, Syntax error.
```

manifest.jsonのところへcrossOrigin="use-credentials"を追加します。プレビューページへのアクセス時に使用している認証情報をmanifest.json取得時にも使用するという感じですね。

```jsx
<link rel="manifest" href="/manifest.json" crossOrigin="use-credentials" />
```

[mdn web docs - Manifest#マニフェストの展開](https://developer.mozilla.org/ja/docs/Web/Manifest#%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E3%81%AE%E5%B1%95%E9%96%8B)

## ひとまず完成

ざざっと一通りやってみましたが、かなり快適に初期構築することができました。一旦構築しないことには何も始まらないので急ぎ足でしたが、今後も Qwik 関連の情報も追っていきたいと思います。

PageSpeed Insightsでの細かな怒られなど調整して無事100が並びました👏

これから画像など様々なコンテンツを追加したり、なにか改修するたびにスコアが下がりそうな気がしますが、しっかりと対応したいと思います。

<FigImage
  alt="PageSpeed Insightsのスコア"
  height={500}
  src="https://storage.ephy.dev/blog-resources/article-cloudflare-pages/pagespeed-insights/"
/>

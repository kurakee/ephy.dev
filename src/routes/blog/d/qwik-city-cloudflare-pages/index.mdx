---
title: QwikCity + CloudflarePages + Newtã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹
description: Newtå…¬å¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å‚è€ƒã«ãƒ–ãƒ­ã‚°ã‚’ä½œæˆã™ã‚‹éç¨‹ã§ãƒãƒã£ãŸã¨ã“ã‚ã‚„ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¤–ã®ä½œæ¥­ãªã©
og:
  - title: QwikCity + CloudflarePages + Newtã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹
    description: true
  - image: https://storage.ephy.dev/blog-resources/article-cloudflare-pages/cover/image.webp
    image:alt: Article cover
publishedAt: "2023-12-06"
tags:
  - Frontend
  - Qwik
  - Cloudflare
---

import { FigImage } from "~/components/utils/fig-image.tsx";
import { Video } from "~/components/utils/video.tsx";
import { ArticleHead } from "~/components/article/article-head";

<ArticleHead />

## æ¦‚è¦

ã“ã®è¨˜äº‹ã§ã¯é€”ä¸­ãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆã‚„ã€è¿½åŠ ã§è¡Œã£ãŸé›‘å¤šãªäº‹ãªã©ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

åŸºæœ¬çš„ã«ã¯[å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://www.newt.so/docs/tutorials/get-contents-in-qwik-city)ã«å¾“ã£ã¦ä½œæˆã—ã€CloudflarePages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰å¾Œã®ã¨ã“ã‚ã¾ã§å®Œäº†ã—ã¦ã„ã‚‹çŠ¶æ…‹ã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚

## è¨˜äº‹ã‚’èª­ã‚€å‰ã«

ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãªã©ã¯æ‰€ã€…çœç•¥ã•ã‚Œã¦ã„ãŸã‚Šã™ã‚‹ã®ã§ã€ã‚³ãƒ”ãƒšã§ã¯å‹•ã‹ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã—å‚è€ƒã«ã•ã‚Œã‚‹æ–¹ãŒå±…ãŸã‚‰ã€è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

[Github - ephy.dev](https://github.com/kurakee/ephy.dev/tree/save/2023-12-08)

## CloudflarePages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã“ã‚

å†…å®¹ã‚’ãªãã‚‹ã ã‘ã§ä¸€æ—¦ã¯ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã¾ã§å®Œæˆã™ã‚‹ã‚‚ã®ã®ã€Newtã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒfetch()ã«å¯¾å¿œã—ã¦ã„ãªã„ãªã©ã®ç†ç”±ã‹ã‚‰ã€axios-fetch-adapterã‚’å°å…¥ã™ã‚‹è¾ºã‚Šã§ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚³ã‚±ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚è‡ªåˆ†ãŒé­é‡ã—ãŸã®ã¯ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

```
Module not found: Package path ./lib/core/settle is not exported from ~
```

axiosã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢ä¿‚ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒè¿‘å¹´ã‚ã£ãŸã‚ˆã†ã«è¨˜æ†¶ã—ã¦ã„ã¾ã™ãŒã€[axios-fetch-adapter](https://github.com/vespaiach/axios-fetch-adapter)ã¯ç‰¹ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ãªã„ã‚ˆã†ã§ã™ã€‚

axios-fetch-adapterã®index.jsã§axiosé–¢ä¿‚ã®importãŒã†ã¾ãè¡Œãˆã¦ã„ãªã„ã®ãŒåŸå› ã§ã€æœ€æ–°ã®axiosã ã¨/libã‹ã‚‰ã§ã¯ãªã/unsafeã‹ã‚‰ã§ãªã„ã¨å‘¼ã¹ãªã‹ã£ãŸã‚Šã™ã‚‹æ§˜å­ã§ã™ã€‚

ã¾ãŸã€forkã—ã¦å°‘ã—æ›¸ãæ›ãˆã¦è¦‹ã¾ã—ãŸãŒã€isStandardBrowserEnv()ç­‰ã®å®Ÿè£…ã¯ã™ã§ã«/utilsã«ã¯ãªãã€ã©ã®ã¿ã¡å‹•ãã¾ã›ã‚“ã§ã—ãŸã€‚

> index.js

```javascript
import settle from "axios/lib/core/settle"; // axios/unsafe/core/settleã¨ã„ã†ã‚ˆã†ã«å‘¼ã¶
import buildURL from "axios/lib/helpers/buildURL";
import buildFullPath from "axios/lib/core/buildFullPath";
import { isUndefined, isStandardBrowserEnv, isFormData } from "axios/lib/utils";
```

[issue](https://github.com/vespaiach/axios-fetch-adapter/issues/22)ã‚‚ä¸ŠãŒã£ã¦ã„ã¦ã€å›°ã£ã¦ã„ã‚‹äººã¯å»å¹´ã‹ã‚‰å±…ã‚‹ã£ã½ã„ã§ã™ã­ã€‚

ã¨ã‚Šã‚ãˆãšã€ãŸã¾ãŸã¾è¦‹ã¤ã‘ãŸãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒã‚¸ãƒˆãƒªã®ã‚‚ã®ã‚’æ‹å€Ÿã™ã‚‹ã“ã¨ã«ã—ã¦ã€ç„¡äº‹ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé€šã‚Šã¾ã—ãŸã€‚

[konfig-axios-fetch-adapter](https://github.com/konfig-dev/konfig-axios-fetch-adapter/)

ä¿¡ç”¨ã§ãã‚‹ã‹ã¯ä¸æ˜ãªã®ã§å„è‡ªåˆ¥ã®ã‚‚ã®ã‚’æ¢ã—ãŸã‚Šã€axios-fetch-adapterã‚’forkã—ã¦è‡ªåˆ†ã§å‹•ãã‚ˆã†ã«ç´°ã‹ãªå¯¾å¿œã‚’ã™ã‚‹ãªã©å¿…è¦ã§ã™ã€‚

---

ã“ã“ã‹ã‚‰ã¯è‡ªåˆ†ãŒè¡Œã£ãŸè¿½åŠ ã®ä½œæ¥­ã‚„ç°¡å˜ãªTipsã«ãªã‚Šã¾ã™ã€‚

## CloudflarePages

ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

- ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
  - [https://kshida-blog.com/posts/set-my-domain-to-cloudflare-pages](https://kshida-blog.com/posts/set-my-domain-to-cloudflare-pages)
  - [https://zenn.dev/kameoncloud/articles/9154d4dd27fe15](https://zenn.dev/kameoncloud/articles/9154d4dd27fe15)
- Access-policy
  - é–‹ç™ºä¸­ã¯ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ãªã„ã‚ˆã†ã«ã™ã‚‹
  - [https://dev.classmethod.jp/articles/cloudflare-pages-access/](https://dev.classmethod.jp/articles/cloudflare-pages-access/)
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š (BulkRedirect)
  - \*.pages.devãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹
  - [https://astro.gdgd.tokyo/posts/cf-redirects/](https://astro.gdgd.tokyo/posts/cf-redirects/)

ã¾ãŸã€CloudflarePages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã¨ããŒã‚ã‚Šã¾ã—ãŸã€‚

```
âœ˜ [ERROR] Received a malformed response from the API
```

æ™‚é–“ã‚’ãŠã„ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½•åº¦ã‹ã™ã‚‹ã¨å•é¡Œãªãé€šã‚‹ã®ã§ç„¦ã‚‰ãšã«ã¡ã‚‡ã“ã¡ã‚‡ã“ã¨å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥è‡ªå‹•ä»˜ä¸ã®è§£é™¤(trailingSlash)

æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã®è‡ªå‹•ä»˜ä¸ãŒå€‹äººçš„ã«å¥½ãã§ã¯ãªã„ã®ã§ã‚ªãƒ•ã«ã—ã¾ã—ãŸã€‚

ä½œæ¥­å†…å®¹ã¨ã—ã¦ã¯ã€vite.config.jså†…ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚ã‚‹ã€qwikCity()ã«trailingSlash: falseã‚’æ¸¡ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

> vite.config.js

```js
import { defineConfig } from "vite";
import { qwikVite } from "@builder.io/qwik/optimizer";
import { qwikCity } from "@builder.io/qwik-city/vite";
import tsconfigPaths from "vite-tsconfig-paths";

export default defineConfig(() => {
  return {
    plugins: [qwikCity({ trailingSlash: false }), qwikVite(), tsconfigPaths()],
    // çœç•¥
  };
});
```

ãã®ä»–ã«ã‚‚è¨­å®šã§ãã‚‹é …ç›®ã¯ã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

[Qwik - vite](https://qwik.builder.io/docs/advanced/vite/)

## ãƒªãƒ³ã‚¯å…ˆã®prefetch

Qwikã«ã¯ä¾¿åˆ©æ©Ÿèƒ½ã®prefetchãŒã‚ã‚Šã¾ã™ã€‚Qwikã®Linkã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½œæˆã—ãŸãƒªãƒ³ã‚¯ã«prefetchã‚’è¨­å®šã™ã‚‹ã¨ã€ãƒªãƒ³ã‚¯ã‚’ãƒ›ãƒãƒ¼ãªã©ã—ãŸæ™‚ç‚¹ã§æ¬¡ã®ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã‚’å§‹ã‚ã¾ã™ã€‚

[Qwik - Link Prefech](https://qwik.builder.io/docs/routing/#link-prefetch)

```jsx
import { Link } from "@builder.io/qwik-city";

<Link prefetch href="/blog">
  Blog
</Link>;
```

## Qwikã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 

ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ•´ãˆã¦ã„ãä¸Šã§ã€ä½•ç¨®é¡ã‹ã‚¢ã‚¤ã‚³ãƒ³ãŒæ¬²ã—ã‹ã£ãŸã®ã§è¿½åŠ ã—ã¾ã™ã€‚

```
npm install @qwikest/icons
```

ä»Šå›ã¯Bootstrapç³»Githubã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ ã€‚

```tsx
import { BsGithub } from "@qwikest/icons/bootstrap";
// ä¸­ç•¥
<BsGithub />;
```

Bootstrapç³»ã«åŠ ãˆã€Octicons(Githubç³»)ã‚„Heroicons(Tailwindç³»)ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚‚é¸ã¹ã‚‹ã®ã§ã€å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦ã¿ã¦ãã ã•ã„ã€‚

[Qwik - icons#qwikesticons](https://qwik.builder.io/docs/integrations/icons/#qwikesticons)

## Qwikç‰¹æœ‰ã®çŠ¶æ…‹ç®¡ç†ã¨ã‹ãŠä½œæ³•

çŠ¶æ…‹ç®¡ç†ã¯åŸºæœ¬çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã£ã¦ã„ã¾ã™ã€‚

- useSignal() å˜ä¸€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾ã—ã¦ä½¿ç”¨
- useStore() ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã—ã¦ä½¿ç”¨

Reactã§è¨€ã†ã¨ã“ã‚ã®useState()ã§ã™ã­ã€‚

ç‰¹ã«ã€useStore()ã«ãã®çŠ¶æ…‹ã«å¯¾ã—ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚€ã®ã¯Qwikã‚‰ã—ã•ãŒã‚ã‚Šã¾ã™ã­ã€‚

```typescript
import { $, useStore } from "@builder.io/qwik";
const state = useStore<CountStore>({
  count: 0,
  increment: $(function (this: CountStore) {
    this.count++;
  }),
}); // onClick$={() => state.increment()} ã®ã‚ˆã†ã«ä½¿ç”¨
```

ä¸Šè¨˜ã®ä¾‹ã«è¿‘ã„è©±ã§ã€onClick$()ãªã©ã«ã¯QRLåŒ–ã§ãã‚‹çŠ¶æ…‹ã§ãªã„ã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ¸¡ã™ã“ã¨ã¯å‡ºæ¥ãšæ€’ã‚‰ã‚Œã¾ã™ã€‚

```
Captured variable in the closure can not be serialized because it's a function named "hogeMethod".
You might need to convert it to a QRL using $(fn)
```

```typescript
import { $ } from "@builder.io/qwik";
// NG
const hogeMethod = () => console.log("hoge");
// onClick$={() => hogeMethod()}

// OK
const fugaMethod = $(() => console.log("fuga"));
// onClick$={() => fugaMethod()}
```

ä»–ã«ã‚‚useCompoted$()ã‚„useResource$()ãªã©ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ä½¿ç”¨ã—ãªã„ã®ã§ã¾ãŸã„ã¤ã‹æ·±å €ã‚Šã—ã¦ã¿ãŸã„ã§ã™ã€‚

[Qwick - State](https://qwik.builder.io/docs/components/state/)

## Qwikã®ç”»åƒã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦

æœ€çµ‚çš„ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã‚„CDNçµŒç”±ã«ãªã£ã¦ã—ã¾ã†æ°—ãŒã—ãªãã‚‚ãªã„ã®ã§ã™ãŒã€ã€Œãã†ã„ã†æ©Ÿèƒ½ã‚‚ã‚ã‚‹ã€ã¨ã„ã†ç¨‹åº¦ã«è§¦ã£ã¦ãŠããŸã„ã¨æ€ã„ã¾ã™ã€‚

Newt ã‹ã‚‰å¾—ã¦ã„ã‚‹æƒ…å ±ã¯ãã®ã¾ã¾ã§ã™ãŒã€ã‚µã‚¤ãƒˆç”¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã¨ã‹ã¯ã©ã†ã‚„ã£ã¦å–ã‚Šæ‰±ã†ã®ã‹ã¨æ€ã£ãŸã‚‰ã‹ãªã‚Šã„ã„æ„Ÿã˜ã§ã—ãŸã€‚src/media/images/profile.pngã¨ã„ã£ãŸã‚ˆã†ã«srcã®é…ä¸‹ã«ç”»åƒã‚’é…ç½®ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```tsx
import ProfileImage from "~/media/images/profile.png?jsx";

<ProfileImage style={{ width: "128px", height: "128px" }} />;
```

webpåŒ–ã¨ã‹æœ€é©ãªè¡¨ç¤ºåˆ†ã‘ãªã©å…¨éƒ¨è‡ªå‹•ã§ã‚„ã£ã¦imgã‚¿ã‚°ã«å¤‰æ›ã—ã¦ãã‚Œã‚‹ã®ã§ã„ã„æ„Ÿã˜ã ã¨æ€ã„ã¾ã—ãŸã€‚

ãã®ä»–è©³ç´°ã¯å…¬å¼ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
[Qwik - Image Optimization](https://qwik.builder.io/docs/integrations/image-optimization/)

## Reactã‚’æ›¸ã„ã¦ã‚‹äººå‘ã‘ã®ãŠå½¹ç«‹ã¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

Qwik ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã« React ã¨ã®å¯¾æ¯”ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’è¦‹ã‚‹ã¨ React æ›¸ã„ã¦ã‚‹äººã¯ç†è§£ãƒ»ç½®ãæ›ãˆã—ã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

[Qwik - React Cheat Sheet](https://qwik.builder.io/docs/guides/react-cheat-sheet/)

## TailwindCSSã‚’å°å…¥

ã„ã‚ã„ã‚ãªé¸æŠè‚¢ãŒæœ€è¿‘ã¯ã‚ã‚Šã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãšTailwindCSSã«ã—ã¦ã¿ã¾ã—ãŸã€‚

```
npm run qwik add tailwind
```

> global.css

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

prettierã«classã®ã‚½ãƒ¼ãƒˆã€.cssãƒ•ã‚¡ã‚¤ãƒ«ã§ã®CSS Propertyã«å¯¾ã™ã‚‹ã‚½ãƒ¼ãƒˆã€importã«å¯¾ã™ã‚‹ã‚½ãƒ¼ãƒˆã‚’ã—ã¦ãã‚Œã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
npm install -D prettier prettier-plugin-tailwindcss prettier-plugin-css-order prettier-plugin-organize-imports
```

> .prettierrc.yml

```yml
plugins:
  - prettier-plugin-tailwindcss
  - prettier-plugin-css-order
  - prettier-plugin-organize-imports
```

vscodeã‚’ä½¿ç”¨ã—ã¦ã„ã¦prettierãŒè‡ªå‹•æ•´å½¢ã—ã¦ãã‚Œãªã„!!ã¨ã„ã†æ™‚ã¯ã€cmd+shift+Pã‹ã‚‰Format Documentã‚’å®Ÿè¡Œã—ã¦ prettierã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚vscodeã®"editor.formatOnSave": trueã‚‚å¿˜ã‚Œãšã«ã€‚

[Qwik - Tailwind](https://qwik.builder.io/docs/integrations/tailwind/)

## PostCSSå‘¨ã‚Šã®èª¿æ•´

Newtã‹ã‚‰å—ã‘å–ã£ãŸè¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦CSSã‚’å½“ã¦ãŸã„ã‚ã‘ã§ã™ãŒã€é€šå¸¸ã®CSSã ã¨Nestå‡ºæ¥ãªã„ã®ã§PostCSSã®èª¿æ•´ã‚’ã—ã¾ã™ã€‚

```
npm install -D postcss
```

```
npm run qwik add postcss
```

PostCSSã‚’è¿½åŠ ã™ã‚‹ã ã‘ã ã¨tailwindãŒè­¦å‘Šã—ã¦ãã‚‹ã¿ãŸã„ãªã®ã§ã€è¨­å®šã‚’ä¿®æ­£ã—ã¾ã™ã€‚

[Qwik - Using with Preprocessors#Nesting](https://tailwindcss.com/docs/using-with-preprocessors#nesting)

```
[vite:css] Nested CSS was detected, but CSS nesting has not been configured correctly.
Please enable a CSS nesting plugin *before* Tailwind in your configuration.
See how here: https://tailwindcss.com/docs/using-with-preprocessors#nesting
```

> postcss.config.js

```javascript
module.exports = {
  plugins: {
    "postcss-import": {},
    "tailwindcss/nesting": "postcss-nesting",
    "postcss-preset-env": {
      stage: 3,
      features: {
        "nesting-rules": true,
      },
    },
    tailwindcss: {},
    autoprefixer: {},
  },
};
```

[Qwik - PostCSS](https://qwik.builder.io/docs/components/styles/#postcss)

## eslintãŒ\*.config.jsã«å¯¾ã—ã¦ãŠæ€’ã‚Šã«ãªã£ã¦ã„ã‚‹å ´åˆ

.eslintignoreã¸ä»¥ä¸‹ã‚’è¿½åŠ 

```
tailwind.config.js
prettier.config.js
postcss.config.js
```

## è¨˜äº‹ç”¨ã®CSSèª¿æ•´

/src/stylesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã‹ã‚‰global.cssã‚’ç§»å‹•ã•ã›ã¦ã€root.tsxã®èª­ã¿è¾¼ã¿å…ˆã‚’ä¿®æ­£ã—ã¾ã™ã€‚

> root.tsx

```
import "~/styles/global.css";
```

åå‰ã¯ä½•ã§ã‚‚ã„ã„ã§ã™ãŒã€ãƒ–ãƒ­ã‚¯è¨˜äº‹éƒ¨åˆ†ã®CSSã‚’æ›¸ããŸã‚ã®cssãƒ•ã‚¡ã‚¤ãƒ«ã‚’/src/stylesã«ä½œæˆã—ã¾ã™ã€‚

> newt-blog-body.css

```css
/* .markdownã˜ã‚ƒãªãã¦ã‚‚OK */
.markdown {
  img,
  video {
    margin: 1em auto;
    max-width: 80%;
    height: auto;
  }
  /* çœç•¥ */
}
```

CSSã‚’ä½œæˆã—ãŸã‚‰ã€è¨˜äº‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ–¹ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚è¨˜äº‹ã‚’è¡¨ç¤ºã™ã‚‹éƒ¨åˆ†ã«å¯¾ã—ã¦ã¯.markdownã®ã‚¯ãƒ©ã‚¹é…ä¸‹ã¨ãªã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

```tsx
import { component$, useStyles$ } from "@builder.io/qwik";
import blogBodyStyle from "~/styles/newt-blog-body.css?inline"; //?inlineã‚’ã¤ã‘ã‚‹

export default component$(() => {
  const article = useArticle();
  useStyles$(blogBodyStyle);

  return (
    <>
      <div class="markdown" dangerouslySetInnerHTML={article.value.body} />
    </>
  );
});
```

## CSP å¯¾å¿œ

/src/routesã«plugin\@csp.tsã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã§è¨­å®šã—ã¾ã™ã€‚ãŸã ã€CSPè¨­å®šã«é–¢ã—ã¦ã¯ã“ã‚ŒãŒæ­£è§£ã¨ã„ã†ã‚ã‘ã§ã¯ãªã„ã®ã§ã€è‡ªèº«ã§å¤–éƒ¨ã‹ã‚‰èª­ã¿è¾¼ã‚€ãƒ‰ãƒ¡ã‚¤ãƒ³ãªã©ã®è¨­å®šã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€youtubeåŸ‹ã‚è¾¼ã¿ç³»ã‚„newtã‚’è¨±å¯ã—ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚

```typescript
import type { RequestHandler } from "@builder.io/qwik-city";
import { isDev } from "@builder.io/qwik/build";

export const onRequest: RequestHandler = (event) => {
  if (isDev) return;
  const nonce = Date.now().toString(36);
  event.sharedMap.set("@nonce", nonce);
  const csp = [
    ["default-src", "'self'", "'unsafe-inline'"],
    ["connect-src", "'self'", "data:", "blob:"],
    ["script-src", "'self'", "'unsafe-inline'", "https:", `'nonce-${nonce}'`, "strict-dynamic"],
    ["frame-src", "'self'", `'nonce-${nonce}'`, "*.youtube.com", "*.google.com"],
    ["img-src", "'self'", "*.newt.so", "*.ytimg.com"],
    ["media-src", "'self'", "*.newt.so"],
  ];

  event.headers.set("Content-Security-Policy", csp.map((k) => k.join(" ")).join("; "));
};
```

nonceã«é–¢ã—ã¦ã¯ä¸€å›é™ã‚Šã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦inline-scriptãªã©ã«åŸ‹ã‚è¾¼ã‚€ã‚„ã¤ã§ã™ã€‚root.tsxã®ServiceWorkerRegisterã«æ¸¡ã™ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

> src/root.tsx

```tsx
export default component$(() => {
  const nonce = useServerData<string | undefined>("nonce");
  return (
    <QwikCityProvider>
      {/* çœç•¥ */}
      <ServiceWorkerRegister nonce={nonce} />
      {/* çœç•¥ */}
    </QwikCityProvider>
  );
});
```

[Qwik - Content Security Policy](https://qwik.builder.io/docs/advanced/content-security-policy/)

## manifest.json ã®ã‚¨ãƒ©ãƒ¼

Cloudflare Pagesã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ã—ã¦ã„ãŸã‚Šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ã£ãŸã‚Šã—ã¦ã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã®å¯¾å¿œã‚‚ã—ã¦ãŠãã¾ã™ã€‚ã“ã‚Œã¯manifest.jsonã‚’å–å¾—ã—ãŸã¨ãã«èªè¨¼ãŒé€šã‚‰ãšã«ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ãªã©ãŒè¿”ã•ã‚Œã¦ã—ã¾ã£ã¦ã€ãã‚ŒãŒhtmlå½¢å¼ã ã£ãŸã‚Šã™ã‚‹æ™‚ã«å‡ºã‚‹ã‚‚ã®ã§ã™ã€‚

```
Manifest: Line: 1, column: 1, Syntax error.
```

manifest.jsonã®ã¨ã“ã‚ã¸crossOrigin="use-credentials"ã‚’è¿½åŠ ã—ã¾ã™ã€‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ä½¿ç”¨ã—ã¦ã„ã‚‹èªè¨¼æƒ…å ±ã‚’manifest.jsonå–å¾—æ™‚ã«ã‚‚ä½¿ç”¨ã™ã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã™ã­ã€‚

```jsx
<link rel="manifest" href="/manifest.json" crossOrigin="use-credentials" />
```

[mdn web docs - Manifest#ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å±•é–‹](https://developer.mozilla.org/ja/docs/Web/Manifest#%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E3%81%AE%E5%B1%95%E9%96%8B)

## ã²ã¨ã¾ãšå®Œæˆ

ã–ã–ã£ã¨ä¸€é€šã‚Šã‚„ã£ã¦ã¿ã¾ã—ãŸãŒã€ã‹ãªã‚Šå¿«é©ã«åˆæœŸæ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ä¸€æ—¦æ§‹ç¯‰ã—ãªã„ã“ã¨ã«ã¯ä½•ã‚‚å§‹ã¾ã‚‰ãªã„ã®ã§æ€¥ãè¶³ã§ã—ãŸãŒã€ä»Šå¾Œã‚‚ Qwik é–¢é€£ã®æƒ…å ±ã‚‚è¿½ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

PageSpeed Insightsã§ã®ç´°ã‹ãªæ€’ã‚‰ã‚Œãªã©èª¿æ•´ã—ã¦ç„¡äº‹100ãŒä¸¦ã³ã¾ã—ãŸğŸ‘

ã“ã‚Œã‹ã‚‰ç”»åƒãªã©æ§˜ã€…ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ ã—ãŸã‚Šã€ãªã«ã‹æ”¹ä¿®ã™ã‚‹ãŸã³ã«ã‚¹ã‚³ã‚¢ãŒä¸‹ãŒã‚Šãã†ãªæ°—ãŒã—ã¾ã™ãŒã€ã—ã£ã‹ã‚Šã¨å¯¾å¿œã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

<FigImage
  alt="PageSpeed Insightsã®ã‚¹ã‚³ã‚¢"
  height={500}
  src="https://storage.ephy.dev/blog-resources/article-cloudflare-pages/pagespeed-insights/"
/>

---
title: QwikCity + CloudflarePages + Newtã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹
description: Newtå…¬å¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’å‚è€ƒã«ãƒ–ãƒ­ã‚°ã‚’ä½œæˆã™ã‚‹éç¨‹ã§ãƒãƒã£ãŸã¨ã“ã‚ã‚„ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å¤–ã®ä½œæ¥­ãªã©
og:
  - title: QwikCity + CloudflarePages + Newtã§ãƒ–ãƒ­ã‚°ã‚’ä½œã‚‹
    description: true
  - image: https://storage.ephy.dev/blog-resources/article-cloudflare-pages/cover/image.webp
    image:alt: Article cover
publishedAt: "2023-12-06"
tags:
  - Frontend
  - Qwik
  - Cloudflare
---

import { FigImage } from "~/components/utils/fig-image.tsx";
import { Video } from "~/components/utils/video.tsx";
import { ArticleHead } from "~/components/article/article-head";

<ArticleHead />

## æ¦‚è¦

ã“ã®è¨˜äº‹ã§ã¯é€”ä¸­ãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆã‚„ã€è¿½åŠ ã§è¡Œã£ãŸé›‘å¤šãªäº‹ãªã©ã‚’ãƒ¡ãƒ¢ã—ã¾ã™ã€‚

åŸºæœ¬çš„ã«ã¯[å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](https://www.newt.so/docs/tutorials/get-contents-in-qwik-city)ã«å¾“ã£ã¦ä½œæˆã—ã€CloudflarePages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å‰å¾Œã®ã¨ã“ã‚ã¾ã§å®Œäº†ã—ã¦ã„ã‚‹çŠ¶æ…‹ã‚’å‰æã«ã—ã¦ã„ã¾ã™ã€‚

## è¨˜äº‹ã‚’èª­ã‚€å‰ã«

ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãªã©ã¯æ‰€ã€…çœç•¥ã•ã‚Œã¦ã„ãŸã‚Šã™ã‚‹ã®ã§ã€ã‚³ãƒ”ãƒšã§ã¯å‹•ã‹ãªã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã‚‚ã—å‚è€ƒã«ã•ã‚Œã‚‹æ–¹ãŒå±…ãŸã‚‰ã€è¨˜äº‹åŸ·ç­†æ™‚ç‚¹ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

[Github - ephy.dev](https://github.com/kurakee/ephy.dev/tree/save/2023-12-08)

## CloudflarePages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¨ã“ã‚

å†…å®¹ã‚’ãªãã‚‹ã ã‘ã§ä¸€æ—¦ã¯ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã¾ã§å®Œæˆã™ã‚‹ã‚‚ã®ã®ã€`axios-fetch-adapter` å‘¨ã‚Šã§ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚³ã‚±ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ã€‚è‡ªåˆ†ãŒé­é‡ã—ãŸã®ã¯ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã§ã™ã€‚

```
Module not found: Package path ./lib/core/settle is not exported from ~
```

æœ€è¿‘axiosé–¢é€£ã§å°‘ã—é¨’ãŒã—ã‹ã£ãŸã‚ˆã†ã«è¨˜æ†¶ã—ã¦ã„ã¾ã™ãŒã€[axios-fetch-adapter](https://github.com/vespaiach/axios-fetch-adapter)ã¯ç‰¹ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ãªã„ã‚ˆã†ã§ã™ã€‚

`axios-fetch-adapter`ã®`index.js`ãŒä½œã‚ŠãŒæ‚ªã•ã‚’ã—ã¦ã„ã¦ã€æœ€æ–°ã®axiosã ã¨`/lib`ã§ã¯ãªã`/unsafe`ã¨ã—ãªã„ã¨å‘¼ã¹ãªã‹ã£ãŸã‚Šã™ã‚‹æ§˜å­ã§ã™ã€‚

ä»®ã«å‘¼ã‚“ã ã¨ã—ã¦ã‚‚ã€`isStandardBrowserEnv`ç­‰ã®å®Ÿè£…ã¯ã™ã§ã«`/utils`ã«ã¯ãªãã€ã©ã®ã¿ã¡å‹•ãã¾ã›ã‚“ã€‚

```javascript
import settle from "axios/lib/core/settle";
import buildURL from "axios/lib/helpers/buildURL";
import buildFullPath from "axios/lib/core/buildFullPath";
import { isUndefined, isStandardBrowserEnv, isFormData } from "axios/lib/utils";
```

[issue](https://github.com/vespaiach/axios-fetch-adapter/issues/22)ã‚‚ä¸ŠãŒã£ã¦ã„ã¦ã€å›°ã£ã¦ã„ã‚‹äººã¯å»å¹´ã‹ã‚‰å±…ã‚‹ã£ã½ã„ã§ã™ã­ã€‚

ã¨ã‚Šã‚ãˆãšã€ãŸã¾ãŸã¾è¦‹ã¤ã‘ãŸãƒ•ã‚©ãƒ¼ã‚¯ãƒªãƒã‚¸ãƒˆãƒªã®ã‚‚ã®ã‚’æ‹å€Ÿã™ã‚‹ã“ã¨ã«ã—ã¦ã€ç„¡äº‹ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé€šã‚Šã¾ã—ãŸã€‚

[konfig-axios-fetch-adapter](https://github.com/konfig-dev/konfig-axios-fetch-adapter/)

ä¿¡ç”¨ã§ãã‚‹ã‹ã¯ä¸æ˜ãªã®ã§ã€å„è‡ªåˆ¥ã®ã‚‚ã®ã‚’æ¢ã—ãŸã‚Š`axios-fetch-adapter`ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã—ã¦è‡ªåˆ†ã§å¯¾å¿œã™ã‚‹ãªã©æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

## CloudflarePages

ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

- ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®š
  - [https://kshida-blog.com/posts/set-my-domain-to-cloudflare-pages](https://kshida-blog.com/posts/set-my-domain-to-cloudflare-pages)
  - [https://zenn.dev/kameoncloud/articles/9154d4dd27fe15](https://zenn.dev/kameoncloud/articles/9154d4dd27fe15)
- Access-policy
  - é–‹ç™ºä¸­ã¯ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ãªã„ã‚ˆã†ã«ã™ã‚‹
  - [https://dev.classmethod.jp/articles/cloudflare-pages-access/](https://dev.classmethod.jp/articles/cloudflare-pages-access/)
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¨­å®š (BulkRedirect)
  - \*.pages.devãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã›ã‚‹
  - [https://astro.gdgd.tokyo/posts/cf-redirects/](https://astro.gdgd.tokyo/posts/cf-redirects/)

ã¾ãŸã€CloudflarePages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã¨ããŒã‚ã‚Šã¾ã—ãŸã€‚

```
âœ˜ [ERROR] Received a malformed response from the API
```

æ™‚é–“ã‚’ãŠã„ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä½•åº¦ã‹ã™ã‚‹ã¨å•é¡Œãªãé€šã‚‹ã®ã§ç„¦ã‚‰ãšã«ã¡ã‚‡ã“ã¡ã‚‡ã“ã¨å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥è‡ªå‹•ä»˜ä¸ã®è§£é™¤(trailingSlash)

æœ«å°¾ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã®è‡ªå‹•ä»˜ä¸ãŒãªã‚“ã ã‹å¥½ãã§ã¯ãªã„ã®ã§ï¼ˆå­ãƒšãƒ¼ã‚¸ã§ã®pathæŒ‡å®šã¯æ¥½ã«ãªã‚Šã¾ã™ãŒâ€¦â€¦ï¼‰ã‚ªãƒ•ã«ã—ã¾ã™ã€‚

`vite.config.js`

```js
import { defineConfig } from "vite";
import { qwikVite } from "@builder.io/qwik/optimizer";
import { qwikCity } from "@builder.io/qwik-city/vite";
import tsconfigPaths from "vite-tsconfig-paths";

export default defineConfig(() => {
  return {
    plugins: [qwikCity({ trailingSlash: false }), qwikVite(), tsconfigPaths()],
    // çœç•¥
  };
});
```

qwikCity()ã«configã«ç›¸å½“ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã—ã¾ã™ã€‚

```js
qwikCity({trailingSlash: false}),
```

ãã®ä»–ã®è¨­å®šã¯[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://qwik.builder.io/docs/advanced/vite/)ã‚’èª­ã‚“ã§ãã ã•ã„ã€‚

## React æ›¸ã„ã¦ã‚‹äººå‘ã‘ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

Qwik ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã« React ã¨ã®å¯¾æ¯”ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’è¦‹ã‚‹ã¨ React æ›¸ã„ã¦ã‚‹äººã¯ç†è§£ãƒ»ç½®ãæ›ãˆã—ã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

[Qwik - React Cheat Sheet](https://qwik.builder.io/docs/guides/react-cheat-sheet/)

## ãƒªãƒ³ã‚¯å…ˆã®prefetch

Qwikã«ã¯ä¾¿åˆ©æ©Ÿèƒ½ã®prefetchãŒã‚ã‚Šã¾ã™ã€‚Qwikã®Linkã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½œæˆã—ãŸãƒªãƒ³ã‚¯ã«`prefetch`ã‚’è¨­å®šã™ã‚‹ã¨ã€ãƒªãƒ³ã‚¯ã‚’ãƒ›ãƒãƒ¼ãªã©ã—ãŸæ™‚ç‚¹ã§æ¬¡ã®ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã‚’å§‹ã‚ã¾ã™ã€‚

[Qwik - Link Prefech](https://qwik.builder.io/docs/routing/#link-prefetch)

```jsx
import { Link } from "@builder.io/qwik-city";

<Link prefetch href="/about">
  About
</Link>;
```

## Qwikã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ 

ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’æ•´ãˆã¦ã„ãä¸Šã§ä½•ç¨®é¡ã‹ã‚¢ã‚¤ã‚³ãƒ³ãŒæ¬²ã—ã‹ã£ãŸã®ã§è¿½åŠ ã—ã¾ã™ã€‚

[Qwik - icons#qwikesticons](https://qwik.builder.io/docs/integrations/icons/#qwikesticons)

```
npm install @qwikest/icons
```

ä»Šå›ã¯Bootstrapç³»Githubã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ ã€‚

```tsx
import { BsGithub } from "@qwikest/icons/bootstrap";
// ä¸­ç•¥
<BsGithub />;
```

## Qwik ç‰¹æœ‰ã®çŠ¶æ…‹ç®¡ç†ã¨ã‹

ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ˜ãƒƒãƒ€ãƒ¼æŒ™å‹•ã§æ—©é€Ÿ useSignal()ã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸã€‚

```tsx
import { component$, useSignal } from "@builder.io/qwik";
import { Link } from "@builder.io/qwik-city";

export const Header = component$(() => {
  const isMobileHeaderVisible = useSignal(false);
  return (
    <>
      {/* çœç•¥ */}
      <div class="flex items-center justify-between">
        <Link prefetch href="/" title="ephy.dev" class="font-bold text-gray-700">
          ephy.dev
        </Link>
        <button
          id="toggleMenu"
          class="block md:hidden"
          onClick$={() => (isMobileHeaderVisible.value = !isMobileHeaderVisible.value)}
          aria-label="header-toggle-button-for-mobile"
        >
          <BsList class={{ hidden: isMobileHeaderVisible.value }} />
          <BsXLg class={{ hidden: !isMobileHeaderVisible.value }} />
        </button>
      </div>
      <nav
        class={`${
          isMobileHeaderVisible.value ? "" : "hidden "
        }fixed text-secondary-700 inset-x-0 bottom-0 top-14 h-screen items-center gap-8 bg-white px-6 md:static md:flex md:h-auto md:bg-transparent md:p-0`}
        id="mobile-menu"
      >
        {/* çœç•¥ */}
      </nav>
    </>
  );
});
```

å˜ä¸€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯`useSignal()`ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`useStore()`ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã§ã™ã€‚ä»Šå›ã¯ boolean ä¿ã¡ãŸã„ã ã‘ãªã®ã§`useSignal()`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```tsx
const isMobileHeaderVisible = useSignal(false);
```

ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰åè»¢ã•ã›ã‚‹ã¨ã„ã†ç°¡å˜ãªå‡¦ç†ã‚’è¦ç´ ã«è¿½åŠ ã—ã¾ã™ã€‚

```tsx
<button onClick$={() => (isMobileHeaderVisible.value = !isMobileHeaderVisible.value)} />
```

ã“ã®ç¨‹åº¦ã®å®Ÿè£…ã«ãã‚‚ãã‚‚`useSignal()`ã™ã‚‰ä½¿ç”¨ã›ãšã« html,css ã§è§£æ±ºã§ãã¦ã—ã¾ã„ãã†ãªæ°—ã‚‚ã—ã¾ã™ãŒã€ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã—ãŸã€‚

<Video src={"https://storage.ephy.dev/blog-resources/article-cloudflare-pages/header/"} />

## Qwik ã®ç”»åƒã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦

æœ€çµ‚çš„ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã‚„CDNçµŒç”±ã«ãªã£ã¦ã—ã¾ã†æ°—ãŒã—ãªãã‚‚ãªã„ã®ã§ã™ãŒã€ã€Œãã†ã„ã†æ©Ÿèƒ½ã‚‚ã‚ã‚‹ã€ã¨ã„ã†ç¨‹åº¦ã«è§¦ã£ã¦ãŠããŸã„ã¨æ€ã„ã¾ã™ã€‚

Newt ã‹ã‚‰å¾—ã¦ã„ã‚‹æƒ…å ±ã¯ãã®ã¾ã¾ã§ã™ãŒã€ã‚µã‚¤ãƒˆç”¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã¨ã‹ã¯ã©ã†ã‚„ã£ã¦å–ã‚Šæ‰±ã†ã®ã‹ã¨æ€ã£ãŸã‚‰ã‹ãªã‚Šã„ã„æ„Ÿã˜ã§ã—ãŸã€‚`src/media/images/profile.png` ã¨ã„ã£ãŸã‚ˆã†ã« src ã®é…ä¸‹ã«ç”»åƒã‚’é…ç½®ã—ã€ä»¥ä¸‹ã®ã‚ˆã†ã«èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```tsx
import ProfileImage from "~/media/images/profile.png?jsx";
// ä¸­ç•¥
<ProfileImage style={{ width: "128px", height: "128px" }} class="mx-auto my-4 rounded-full" alt="profile image" />;
```

`img`ã‚¿ã‚°ã®èª­ã¿è¾¼ã¿æ™‚ã ã¨ `height={128} width={128}` ã¨ã„ã£ãŸAttributeã‚’è¨­å®šã—ã¾ã™ãŒã€ã“ã®å‘¼ã³å‡ºã—æ–¹ã®å ´åˆã¯`style={}` ã§è¨­å®šã—ã¾ã™ã€‚webpåŒ–ã¨ã‹æœ€é©ãªè¡¨ç¤ºåˆ†ã‘ãªã©å…¨éƒ¨è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹ã®ã§æã‚ã—ã„ã§ã™ã€‚

è¡¨ç¤ºå¾Œã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚(Chrome ã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’æŠ½å‡º)

```html
<img
  srcset="/@imagetools/2d4d49d2bb723c5924a223ffb0a2a9e336435dff 200w, /@imagetools/1ff4ecd5da1f93652b290b7b65fd9c1889d47bf6 400w"
  width="400"
  height="400"
  decoding="async"
  loading="lazy"
  style="width:128px;height:128px"
  alt="profile image"
  class="mx-auto my-4 rounded-full"
  q:key="yQ_0"
  data-qwik-inspector="routes/index.tsx:12:13"
></img>
```

ãã®ä»–è©³ç´°ã¯å…¬å¼ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
[Qwik - Image Optimization](https://qwik.builder.io/docs/integrations/image-optimization/)

## TailwindCSSã‚’å°å…¥

ã¨ã‚Šã‚ãˆãšTailwindCSSãŒå¥½ããªã®ã§å°å…¥ã—ã¾ã™ã€‚

[Qwik - Tailwind](https://qwik.builder.io/docs/integrations/tailwind/)

```
npm run qwik add tailwind
```

`global.css`

```css
@tailwind base;
@tailwind components;
@tailwind utilities;
```

prettierã«classã®ã‚½ãƒ¼ãƒˆã€.cssãƒ•ã‚¡ã‚¤ãƒ«ã§ã®CSS Propertyã«å¯¾ã™ã‚‹ã‚½ãƒ¼ãƒˆã€importã«å¯¾ã™ã‚‹ã‚½ãƒ¼ãƒˆã‚’ã—ã¦ãã‚Œã‚‹ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
npm install -D prettier prettier-plugin-tailwindcss prettier-plugin-css-order prettier-plugin-organize-imports
```

`.prettierrc.yml`

```yml
plugins:
  - prettier-plugin-tailwindcss
  - prettier-plugin-css-order
  - prettier-plugin-organize-imports
```

prettierãŒè‡ªå‹•æ•´å½¢ã—ã¦ãã‚Œãªã„!! ã¨ã„ã†æ™‚ã¯ã€`cmd`+`shift`+`P` ã‹ã‚‰ `> Format Document` ã‚’å®Ÿè¡Œã—ã¦ prettierã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚vscodeã®`"editor.formatOnSave": true`ã‚‚å¿˜ã‚Œãšã«ã€‚

## PostCSSå‘¨ã‚Šã®èª¿æ•´

Newtã‹ã‚‰å—ã‘å–ã£ãŸè¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã«CSSã‚’å½“ã¦ãŸã„ã‚ã‘ã§ã™ãŒã€ãã®ã¾ã¾ã®CSSã‚’æ›¸ãã®ã¯å«Œãªã®ã§ã€PostCSSã®èª¿æ•´ã‚’ã—ã¾ã™ã€‚

[Qwik - PostCSS](https://qwik.builder.io/docs/components/styles/#postcss)

```
npm install -D postcss
```

```
npm run qwik add postcss
```

PostCSSã‚’è¿½åŠ ã™ã‚‹ã ã‘ã ã¨tailwindãŒè­¦å‘Šã—ã¦ãã‚‹ã¿ãŸã„ãªã®ã§ã€è¨­å®šã‚’ä¿®æ­£ã—ã¾ã™ã€‚

[Qwik - Using with Preprocessors#Nesting](https://tailwindcss.com/docs/using-with-preprocessors#nesting)

```
[vite:css] Nested CSS was detected, but CSS nesting has not been configured correctly.
Please enable a CSS nesting plugin *before* Tailwind in your configuration.
See how here: https://tailwindcss.com/docs/using-with-preprocessors#nesting
```

`postcss.config.js`

```js
module.exports = {
  plugins: {
    "postcss-import": {},
    "tailwindcss/nesting": "postcss-nesting",
    "postcss-preset-env": {
      stage: 3,
      features: {
        "nesting-rules": true,
      },
    },
    tailwindcss: {},
    autoprefixer: {},
  },
};
```

## eslintãŒ\*.config.jsã«å¯¾ã—ã¦ãŠæ€’ã‚Šã«ãªã£ã¦ã„ã‚‹å ´åˆ

`.eslintignore` ã¸ä»¥ä¸‹ã‚’è¿½åŠ 

```
tailwind.config.js
prettier.config.js
postcss.config.js
```

## è¨˜äº‹ç”¨ã®CSSèª¿æ•´

`/src/styles` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã‹ã‚‰`global.css`ã‚’ç§»å‹•ã•ã›ã¦ã€`root.tsx`ã®èª­ã¿è¾¼ã¿å…ˆã‚’ä¿®æ­£ã—ã¾ã™ã€‚

`root.tsx`

```
import "~/styles/global.css";
```

`newt-blog-body.css`

```css
.markdown {
  img,
  video {
    margin: 1em auto;
    max-width: 80%;
    height: auto;
  }
  /*çœç•¥ */
}
```

CSSã‚’ä½œæˆã—ãŸã‚‰ã€è¨˜äº‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ–¹ã§èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```tsx
import { component$, useStyles$ } from "@builder.io/qwik";
import blogBodyStyle from "~/styles/newt-blog-body.css?inline";
// çœç•¥
export default component$(() => {
  const article = useArticle();
  useStyles$(blogBodyStyle);
  // çœç•¥
  return (
    <>
      <div class="markdown" dangerouslySetInnerHTML={article.value.body} />
    </>
  );
});
```

## Newtã®å‹å®šç¾©

Newtã§å®šç¾©ã—ãŸãƒ¢ãƒ‡ãƒ«ãŸã¡ã®å‹ãŒå¿…è¦ãªã®ã§ä½œæˆã—ã¾ã™ã€‚

\_sysã¨ã‹ç”»åƒç³»ã¯åŒã˜æ§‹é€ ã£ã½ã„ã®ã§ä¸€æ—¦å…±é€šåŒ–ã—ã¦ã¿ã¾ã—ãŸã€‚ä»¥ä¸‹ã®å®šç¾©ã¯Newtã®ãƒ–ãƒ­ã‚°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã®å†…å®¹ãªã®ã§ã€ç‹¬è‡ªã«å®šç¾©ã—ãŸã‚Šå¤‰æ›´ã—ã¦ã„ã‚‹äººã¯é©å®œèª­ã¿æ›¿ãˆã¦ãã ã•ã„ã€‚

`newt-sys.ts`

```ts
export interface NewtSys {
  createdAt: string;
  updatedAt: string;
  raw: {
    createdAt: string;
    updatedAt: string;
    firstPublishedAt: string;
    publishedAt: string;
  };
}
```

`newt-image.ts`

```ts
export interface NewtImage {
  _id: string;
  src: string;
  fileType: string;
  fileSize: number;
  fileName: string;
  width: number;
  height: number;
  title: string;
  altText: string;
  description: string;
}
```

`article.ts`

```ts
import type { NewtImage } from "~/types/newt-image";
import type { NewtSys } from "~/types/newt-sys";
import type { Author } from "~/types/author";
import type { Tag } from "~/types/tag";

export interface Article {
  _id: string;
  _sys: NewtSys;
  title: string;
  slug: string;
  meta: {
    title: string;
    description: string;
    ogImage: NewtImage;
  };
  body: string;
  coverImage: NewtImage;
  author: Author;
  tags: Tag[];
}
```

`author.ts`

```ts
import type { NewtSys } from "~/types/newt-sys";
import type { NewtImage } from "~/types/newt-image";

export interface Author {
  _id: string;
  _sys: NewtSys;
  fullName: string;
  slug: string;
  biography: string;
  profileImage: NewtImage;
}
```

## ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®ä½œæˆ

ãƒ–ãƒ­ã‚°ä½œæˆæ™‚ç‚¹ã§ã¯ã‚ã¾ã‚Šæ„å‘³ãªã„æ°—ã‚‚ã—ã¾ã™ãŒã€ç°¡å˜ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ä½œæˆã—ãŸè¨˜äº‹ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å–å¾—å‡¦ç†ã«å°‘ã—å‡¦ç†ã‚’è¿½åŠ ã—ã¾ã™ã€‚ã„ã‚ã„ã‚ã¨ã‚„ã‚Šæ–¹ã¯ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã¯ã¨ã‚Šã‚ãˆãš`/blog?page=1`ã¨ã„ã†æ§˜ã«ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ãƒšãƒ¼ã‚¸ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ã„ãä»•æ§˜ã§è¡Œãã¾ã™ã€‚

Newt ã¯ã‚¯ã‚¨ãƒªã«`limit`ã¨`skip`ãŒè¨­å®šã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

[Newt API Reference - Content Queries#Limit](https://developers.newt.so/apis/cdn#tag/contents_general/Queries/Limit)

```tsx
export interface Pager {
  page: number;
  pageCount: number;
}

interface ArticleAndPager {
  articles: Article[];
  pager: Pager;
}

export const useArticles = routeLoader$(async ({ env, query }): Promise<ArticleAndPager> => {
  const spaceUid = env.get("NEWT_SPACE_UID") || "";
  const token = env.get("NEWT_CDN_API_TOKEN") || "";
  const client = generateClient(spaceUid, token);

  const limit = 4; // ä¸€æ—¦1ãƒšãƒ¼ã‚¸4è¨˜äº‹ã¨ã—ã¾ã™
  const page = query.has("page") ? Number(query.get("page")) : 1;
  const skip = Math.max(0, page - 1) * limit; // æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã®ãŸã‚ã«ç¹°ã‚Šä¸Šã’

  const { total, items: articles } = await client.getContents<Article>({
    appUid: "blog",
    modelUid: "article",
    query: {
      select: ["_id", "_sys", "title", "meta", "slug", "body", "coverImage", "tags"],
      limit: limit,
      skip: skip,
    },
  });
  const pager = {
    page: page,
    pageCount: Math.ceil(total / 4),
  };

  return { articles: articles, pager: pager };
});
```

ã„ã‚ã‚†ã‚‹ Middleware é–¢æ•°ã¯`RequestEvent`ãŒæ¸¡ã•ã‚Œã‚‹ã®ã§ã€ãã“ã‹ã‚‰`query`ã‚’å—ã‘å–ã£ã¦ã„ã¾ã™ã€‚

[Qwik - Middleware#RequestEvent](https://qwik.builder.io/docs/middleware/#requestevent)

```tsx
export const useArticles = routeLoader$(async ({ env, query }): Promise<ArticleAndPager> => {});
```

ãƒšãƒ¼ã‚¸ãƒ£ãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```tsx
import { component$ } from "@builder.io/qwik";
import { Link } from "@builder.io/qwik-city";
import { BsChevronLeft, BsChevronRight } from "@qwikest/icons/bootstrap";
import type { Pager } from "~/types/pager";

interface PagerProps {
  pager: Pager;
}

export const ArticlePager = component$<PagerProps>((props) => {
  const pager = props.pager;
  const prevQuery = new URLSearchParams({ page: Math.max(1, pager.page - 1).toString() }).toString();
  const nextQuery = new URLSearchParams({ page: Math.max(1, pager.page + 1).toString() }).toString();

  return (
    <div class="flex justify-center">
      <nav aria-label="Pagination">
        <ul class="inline-flex items-center space-x-1 rounded-md text-sm">
          {pager.page > 1 && (
            <li>
              <Link
                prefetch
                href={`/blog?${prevQuery}`}
                class="inline-flex items-center space-x-2 rounded-md border border-gray-300 bg-white px-4 py-2 font-medium text-gray-500 hover:bg-gray-50"
              >
                <BsChevronLeft />
                <span>Previous</span>
              </Link>
            </li>
          )}
          <li>
            <span class="inline-flex items-center rounded-md bg-white px-4 py-2 text-gray-500">
              Page <b class="mx-1">{pager.page}</b> of <b class="ml-1">{pager.pageCount}</b>
            </span>
          </li>
          {pager.page < pager.pageCount && (
            <li>
              <Link
                prefetch
                href={`/blog?${nextQuery}`}
                class="inline-flex items-center space-x-2 rounded-md border border-gray-300 bg-white px-4 py-2 font-medium text-gray-500 hover:bg-gray-50"
              >
                <span>Next</span>
                <BsChevronRight />
              </Link>
            </li>
          )}
        </ul>
      </nav>
    </div>
  );
});
```

ã„ã„æ„Ÿã˜ã«å‹•ä½œã—ã¦ãã‚Œã¾ã—ãŸã€‚

<Video src={"https://storage.ephy.dev/blog-resources/article-cloudflare-pages/pager/"} />

## CSP å¯¾å¿œ

[Qwik - Content Security Policy](https://qwik.builder.io/docs/advanced/content-security-policy/)

`plugin@csp.ts`

```ts
import type { RequestHandler } from "@builder.io/qwik-city";
import { isDev } from "@builder.io/qwik/build";

export const onRequest: RequestHandler = (event) => {
  if (isDev) return;
  const nonce = Date.now().toString(36);
  event.sharedMap.set("@nonce", nonce);
  const csp = [
    ["default-src", "'self'", "'unsafe-inline'"],
    ["connect-src", "'self'", "data:", "blob:"],
    ["script-src", "'self'", "'unsafe-inline'", "https:", `'nonce-${nonce}'`, "strict-dynamic"],
    ["frame-src", "'self'", `'nonce-${nonce}'`, "*.youtube.com", "*.google.com"],
    ["img-src", "'self'", "*.newt.so", "*.ytimg.com"],
    ["media-src", "'self'", "*.newt.so"],
  ];

  event.headers.set("Content-Security-Policy", csp.map((k) => k.join(" ")).join("; "));
};
```

## manifest.json ã®ã‚¨ãƒ©ãƒ¼

Cloudflare Pages ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ã—ã¦ã„ãŸã‚Šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ä½¿ã£ãŸã‚Šã—ã¦ã„ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹å ´åˆã®å¯¾å¿œã‚‚ä¸€å¿œã—ã¦ãŠãã¾ã™ã€‚

```
Manifest: Line: 1, column: 1, Syntax error.
```

[mdn web docs - Manifest#ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å±•é–‹](https://developer.mozilla.org/ja/docs/Web/Manifest#%E3%83%9E%E3%83%8B%E3%83%95%E3%82%A7%E3%82%B9%E3%83%88%E3%81%AE%E5%B1%95%E9%96%8B)

```jsx
<link rel="manifest" href="/manifest.json" crossOrigin="use-credentials" />
```

## ã²ã¨ã¾ãšå®Œæˆ

ã–ã–ã£ã¨ä¸€é€šã‚Šã‚„ã£ã¦ã¿ã¾ã—ãŸãŒã€ã‹ãªã‚Šå¿«é©ã«åˆæœŸæ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ä¸€æ—¦æ§‹ç¯‰ã—ãªã„ã“ã¨ã«ã¯ä½•ã‚‚å§‹ã¾ã‚‰ãªã„ã®ã§æ€¥ãè¶³ã§ã—ãŸãŒã€ä»Šå¾Œã‚‚ Qwik é–¢é€£ã®æƒ…å ±ã‚‚è¿½ã£ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

PageSpeed Insightsã§ã®ç´°ã‹ãªæ€’ã‚‰ã‚Œãªã©èª¿æ•´ã—ã¦ç„¡äº‹100ãŒä¸¦ã³ã¾ã—ãŸğŸ‘

ã“ã‚Œã‹ã‚‰ç”»åƒãªã©æ§˜ã€…ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¿½åŠ ã—ãŸã‚Šã€ãªã«ã‹æ”¹ä¿®ã™ã‚‹ãŸã³ã«ã‚¹ã‚³ã‚¢ãŒä¸‹ãŒã‚Šãã†ãªæ°—ãŒã—ã¾ã™ãŒã€ã—ã£ã‹ã‚Šã¨å¯¾å¿œã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

<FigImage
  alt="PageSpeed Insightsã®ã‚¹ã‚³ã‚¢"
  height={500}
  src="https://storage.ephy.dev/blog-resources/article-cloudflare-pages/pagespeed-insights/"
/>

ç¾å ´ã‹ã‚‰ã¯ä»¥ä¸Šã§ã™ã€‚
